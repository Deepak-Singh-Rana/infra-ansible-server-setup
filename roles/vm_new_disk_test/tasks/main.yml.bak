---
#https://serverfault.com/questions/1060123/how-to-fetch-the-disk-difference-before-and-after-adding-a-new-disk

# tasks file for vm_new_disk_test
- name: Bare include (free-form)
  include_vars: main.yml

#create custom facts dir to store our before and after facts
- name: Create directory for ansible custom facts
  ansible.builtin.file:
    state: directory
    recurse: true
    path: /etc/ansible/facts.d

#show the current contents of ansible_local
- debug:
    var: ansible_local

#set the fact variable
- name: set before fact
  ansible.builtin.set_fact:
#    before_add: "{{ ansible_local['devices']['general']['before_add']|default([]) }}"
    before_add: "{{ ansible_facts['devices'] }}"


#save the fact in a file
- name: Install custom devices fact
  ansible.builtin.copy:
    content: |
      {"general": {"before_add": {{ before_add }} }}
    dest: /etc/ansible/facts.d/devicesbefore.fact


#- name: Re-read facts after adding custom fact
#  ansible.builtin.setup:

- name: output disk variable
  ansible.builtin.debug:
    msg: "{{ ansible_facts['devices'] }}"


#add a new disk to vmware
- name: Add disks to virtual machine using UUID
  delegate_to: 127.0.0.1
  community.vmware.vmware_guest_disk:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datacenter: "{{ datacenter_name }}"
    name: "{{ vcenter_vmname }}"
    disk:
      - size_mb: 10
        type: thick
        autoselect_datastore: yes
        state: present
        scsi_controller: 1
        unit_number: 2
        scsi_type: 'paravirtual'
        disk_mode: 'persistent'
    validate_certs: no
  register: disk_facts

#- name: output disk varialbe
#  ansible.builtin.debug:
#    msg: "{{ disk_facts }}"

#reread the facts to detect new disk
- name: Re-read facts after adding custom fact
  ansible.builtin.setup:

#set the fact variable
- name: set after fact
  ansible.builtin.set_fact:
    after_add: "{{ ansible_facts['devices'] }}"

#save the after fact in a file
- name: Install custom devices fact
  ansible.builtin.copy:
    content: |
      {"general": {"after_add": {{ after_add }} }}
    dest: /etc/ansible/facts.d/devicesafter.fact


#reread the custom facts only
- name: Re-read facts after adding custom fact
  ansible.builtin.setup:
    filter: ansible_local

#- name: output new disk varialbe
#  ansible.builtin.debug:
#    msg: "{{ ansible_facts['devices'] }}"

- debug:
    msg: "{{ after_add|difference(before_add) }}"

#- debug:
#    msg: "{{ after_add|symmetric_difference(before_add) }}"
