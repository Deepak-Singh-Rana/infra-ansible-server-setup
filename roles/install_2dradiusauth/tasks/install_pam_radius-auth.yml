#we do this first so our configuration is already set
- name: copy over pam_radius_auth.conf if it doesn't exist
  copy:
   src: etc/pam_radius_auth.conf
   dest: /etc/pam_radius_auth.conf
   owner: root
   group: root
   mode: '0600'
   force: no
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

- name: make sure useful tools are installed ubuntu18
  apt:
    name:
    - pwgen
    - libmysqlclient20
    - libpam-radius-auth
    - nscd
    state: present
  when: ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18"

- name: make sure useful tools are installed ubuntu20
  apt:
    name:
    - pwgen
    - libmysqlclient21
    - libpam-radius-auth
    - nscd
    state: present
  when: ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20"

- name: install libnss-mysql-bg from ubuntu 16 repo
  apt:
    deb: http://odin.snap.net.nz/ubuntu/pool/universe/libn/libnss-mysql-bg/libnss-mysql-bg_1.5-4build1_amd64.deb

- name: copy set-pam-radius.pl to server
  copy:
   src: sbin/set-pam-radius.sh
   dest: /usr/local/sbin/set-pam-radius.sh
   mode: '0700'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

- name: copy libnss-mysql-root.cfg to server
  copy:
   src: etc/libnss-mysql-root.cfg
   dest: /etc/libnss-mysql-root.cfg
   mode: '0640'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

- name: copy libnss-mysql.cfg to server
  copy:
   src: etc/libnss-mysql.cfg
   dest: /etc/libnss-mysql.cfg
   mode: '0640'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

- name: pam config 2d-auth mkhome
  copy:
   src: pam-configs/2d-mkhome
   dest: /usr/share/pam-configs/2d-mkhome
   mode: '0622'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

- name: pam config 2d-radius-auth radius
  copy:
   src: pam-configs/2d-radiusauth
   dest: /usr/share/pam-configs/2d-radiusauth
   mode: '0622'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

- name: pam config 2d-auth rootsecuretty
  copy:
   src: pam-configs/2d-rootsecuretty
   dest: /usr/share/pam-configs/2d-rootsecuretty
   mode: '0622'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

- name: pam config 2d-auth shells
  copy:
   src: pam-configs/2d-shells
   dest: /usr/share/pam-configs/2d-shells
   mode: '0622'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

#- name: remove nullok_secure from unix pam config file
#  replace:
#    path: /etc/pam_radius_auth.conf
#    regexp: '^(.*)nullok_secure(.*)$'
#    replace: '\g<1>{{ vm_radius_secret }}\g<2>'

- name: replace pam-configs unix
  ansible.builtin.copy:
   src: pam-configs/2d-unix
   dest: /usr/share/pam-configs/unix
   mode: '0622'
   owner: root
   group: root
  when: (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "18") or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == "20")

